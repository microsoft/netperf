name: Custom Tasks

on:
  workflow_dispatch:

permissions: write-all

jobs:
  test-job-fail:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        vec: [
          { env: "lab",   os: "2022", arch: "x64" },
          { env: "azure",   os: "2022", arch: "x64" },
        ]
    steps:
      - name: Create dummy file/folders
        run: |
          mkdir artifacts
          mkdir artifacts/logs
          mkdir artifacts/logs/msquiccoretest
          mkdir artifacts/logs/msquictest
          mkdir artifacts/logs/msquicplatformtest
          mkdir artifacts/logs/msquiccoretest/1
          mkdir artifacts/logs/msquictest/1
          mkdir artifacts/logs/msquiccoretest/1/test_case_1
          New-Item -Path artifacts/logs/msquiccoretest/1/test_case_1 -ItemType File
          mkdir artifacts/logs/msquictest/1/test_case_2
          New-Item -Path artifacts/logs/msquictest/1/test_case_2/test_case_2.log -ItemType File
        shell: pwsh
      - name: Upload BVT
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3
        with:
          name: BVT-${{ matrix.vec.env }}-${{ matrix.vec.os }}-${{ matrix.vec.arch }}
          path: artifacts
      - name: Fail on purpose
        run: exit 1
        shell: pwsh

  test-job-pass:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        vec: [
          { env: "lab",   os: "2022", arch: "x64" },
          { env: "azure",   os: "2022", arch: "x64" },
        ]
    steps:
      - name: Create dummy file/folders
        run: |
          mkdir artifacts
          mkdir artifacts/logs
          mkdir artifacts/logs/msquiccoretest
          mkdir artifacts/logs/msquictest
          mkdir artifacts/logs/msquicplatformtest
        shell: pwsh

  Complete_1:
    name: Complete_1
    if: always()
    needs: [test-job-fail]
    runs-on: ubuntu-latest
    permissions: {} # No need for any permissions.
    steps:
    - name: Decide whether the needed jobs succeeded or failed
      uses: re-actors/alls-green@05ac9388f0aebcb5727afa17fcccfecd6f8ec5fe
      with:
        jobs: ${{ toJSON(needs) }}

  Create-Or-Update-Issue:
    needs: [Complete_1]
    if: failure()
    runs-on: ubuntu-latest
    steps:
    - name: Download BVT Failures
      uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0
      with:
        pattern: BVT-*
        path: artifacts
        merge-multiple: false

    - name: Create or Update Issue
      uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
      with:
        script: |
          const fs = require('fs');
          const path = require('path');

          const root = 'artifacts'
          const potential_issues = [];

          class Issue {
              constructor(title, description) {
                  this.title = title;
                  this.description = description;
              }
          }

          let run_url = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`

          for (const env of fs.readdirSync(root)) {
            // If env is not a directory, skip it.
            if (!fs.statSync(path.join(root, env)).isDirectory()) {
                continue;
            }
            for (const log of fs.readdirSync(path.join(root, env, 'logs', 'msquictest'))) {
              // If log is not a directory, skip it.
              if (!fs.statSync(path.join(root, env, 'logs', 'msquictest', log)).isDirectory()) {
                continue;
              }
              for (const testcase of fs.readdirSync(path.join(root, env, 'logs', 'msquictest', log))) {
                let title = `[CI - FAILURE]: ${env} / ${testcase} (msquictest)`
                let new_issue = new Issue(title, run_url);
                potential_issues.push(new_issue);
              }
            }
            for (const log of fs.readdirSync(path.join(root, env, 'logs', 'msquicplatformtest'))) {
              // If log is not a directory, skip it.
              if (!fs.statSync(path.join(root, env, 'logs', 'msquicplatformtest', log)).isDirectory()) {
                continue;
              }
              for (const testcase of fs.readdirSync(path.join(root, env, 'logs', 'msquicplatformtest', log))) {
                let title = `[CI - FAILURE]: ${env} / ${testcase} (msquicplatformtest)`
                let new_issue = new Issue(title, run_url);
                potential_issues.push(new_issue);
              }
            }
            for (const log of fs.readdirSync(path.join(root, env, 'logs', 'msquiccoretest'))) {
              // If log is not a directory, skip it.
              if (!fs.statSync(path.join(root, env, 'logs', 'msquiccoretest', log)).isDirectory()) {
                continue;
              }
              for (const testcase of fs.readdirSync(path.join(root, env, 'logs', 'msquiccoretest', log))) {
                let title = `[CI - FAILURE]: ${env} / ${testcase} (msquiccoretest)`
                let new_issue = new Issue(title, run_url);
                potential_issues.push(new_issue);
              }
            }
          }
          for (let Issue of potential_issues) {
              console.log(Issue.title);
              console.log(Issue.description);
          }


          // --- Prepare to File Issues ---
          const dedup = new Map();
          for (const it of potential_issues) {
            if (!dedup.has(it.title)) dedup.set(it.title, it);
          }
          const issuesToFile = [...dedup.values()];

          // --- Fetch all open issues once (pagination safe) ---
          const openIssues = await github.paginate(
            github.rest.issues.listForRepo,
            { owner, repo, state: 'open', per_page: 100 }
          );

          // Build a quick lookup by title
          const openByTitle = new Map(openIssues.map(i => [i.title, i]));

          // --- Upsert: comment on existing (open) or create a new issue ---
          for (const it of issuesToFile) {
            const existing = openByTitle.get(it.title);
            if (existing) {
              await github.rest.issues.createComment({
                owner, repo,
                issue_number: existing.number,
                body: it.description
              });
              core.notice(`Commented on existing issue #${existing.number}: ${it.title}`);
            } else {
              const created = await github.rest.issues.create({
                owner, repo,
                title: it.title,
                body: it.description,
                labels: ['bvt', 'ci-failure'] // tweak/remove labels as you wish
              });
              core.notice(`Created issue #${created.data.number}: ${it.title}`);
            }
          }

          // Optional: log what we processed
          core.summary
            .addHeading('BVT Failure Issues')
            .addList(issuesToFile.map(i => i.title))
            .addLink('Workflow run', runUrl)
            .write();

  Complete_2:
    name: Complete_2
    if: always()
    needs: [test-job-pass]
    runs-on: ubuntu-latest
    permissions: {} # No need for any permissions.
    steps:
    - name: Decide whether the needed jobs succeeded or failed
      uses: re-actors/alls-green@05ac9388f0aebcb5727afa17fcccfecd6f8ec5fe
      with:
        jobs: ${{ toJSON(needs) }}

  Create-Or-Update-Issue_2:
    needs: [Complete_2]
    if: failure()
    runs-on: ubuntu-latest
    steps:
    - name: Download BVT Failures
      uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0
      with:
        pattern: BVT-*
        path: artifacts
        merge-multiple: false
        