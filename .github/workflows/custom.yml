name: Custom Tasks

on:
  workflow_dispatch:

permissions: write-all

jobs:
  create-runner:
    name: Create Runner
    runs-on: windows-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Login to Azure
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        enable-AzPSSession: true
    - name: Update Azure PowerShell
      uses: azure/powershell@v1
      with:
        azPSVersion: "latest"
        inlineScript: Update-Module Az -Force
    - name: Create Azure VMs
      uses: azure/powershell@v1
      with:
        azPSVersion: "latest"
        inlineScript: |
          ./.github/workflows/create-azure-machines.ps1 `
            -Os windows-2022 `
            -VMSize Standard_F8s_v2 `
            -GitHubToken ${{ secrets.GITHUB_TOKEN }}
  test-runner:
    name: Test Runner
    needs: [create-runner]
    runs-on:
    - self-hosted
    - os-windows-2022
    - azure-ex
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Test Runner
      shell: pwsh
      run: |
        Write-Host 'Connecting to netperf-peer'
        $Session = New-PSSession -ComputerName "netperf-peer" -ConfigurationName PowerShell.7
        ipconfig /all
        Invoke-Command -Session $Session -ScriptBlock {
          ipconfig /all
        }
