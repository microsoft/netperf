name: Custom Tasks

on:
  workflow_dispatch:
    inputs:
      os:
        description: 'Windows OS Version'
        required: false
        default: "2022"
        type: choice
        options:
          - "2025"
          - "2022"
          - "2019"

permissions: write-all

jobs:
  testjob:
    strategy:
      matrix:
        role: ["client", "server"]
    runs-on: [self-hosted, 1ES.Pool=netperf-aztestpool]
    steps:
      - name: Print Role
        run: Write-Host "Role; ${{ matrix.role }}"
        shell: pwsh

      - name: Print networking information
        run: Get-NetIpAddress -AddressFamily IPv4
        shell: pwsh

      - name: Preparing to upload ip address as an .txt artifact
        if: ${{ matrix.role == 'server' }}
        run: |
          (Get-NetIpAddress -AddressFamily IPv4).IpAddress | Out-File -FilePath ipaddress.txt
        shell: pwsh

      - name: Upload ip address as an artifact
        if: ${{ matrix.role == 'server' }}
        uses: actions/upload-artifact@v2
        with:
          name: ipaddress
          path: ipaddress.txt

      - name: Poll for an ip address uploaded by the server
        if: ${{ matrix.role == 'client' }}
        run: |
          $repo = "${{ github.repository }}"
          $runId = "${{ github.run_id }}"
          $found = $false
          do {
            Write-Output "Checking for artifact..."
            $artifacts = gh artifact list --repo $repo --workflow-run-id $runId | Out-String
            Write-Output $artifacts
            if ($artifacts -like "*ipaddress*") {
              Write-Output "Artifact 'ipaddress' found!"
              $found = $true
            } else {
              Write-Output "Artifact 'ipaddress' not found. Waiting for 30 seconds..."
              Start-Sleep -Seconds 30
            }
          } while (-not $found)
        shell: pwsh

      - name: Download ip address artifact
        if: ${{ matrix.role == 'client' }}
        uses: actions/download-artifact@v2
        with:
          name: ipaddress
        shell: pwsh

      - name: Print server ip address
        if: ${{ matrix.role == 'client' }}
        run: Get-Content ipaddress.txt
        shell: pwsh

      - name: Prepare to upload ACK as an artifact
        if: ${{ matrix.role == 'client' }}
        run: |
          "ACK" | Out-File -FilePath ack.txt
        shell: pwsh

      - name: Upload ACK as an artifact
        if: ${{ matrix.role == 'client' }}
        uses: actions/upload-artifact@v2
        with:
          name: ack
          path: ack.txt

      - name: Server polls for an ACK so it can clean up
        if: ${{ matrix.role == 'server' }}
        run: |
          $repo = "${{ github.repository }}"
          $runId = "${{ github.run_id }}"
          $found = $false
          do {
            Write-Output "Checking for artifact..."
            $artifacts = gh artifact list --repo $repo --workflow-run-id $runId | Out-String
            Write-Output $artifacts
            if ($artifacts -like "*ack*") {
              Write-Output "Artifact 'ack' found!"
              $found = $true
            } else {
              Write-Output "Artifact 'ack' not found. Waiting for 30 seconds..."
              Start-Sleep -Seconds 30
            }
          } while (-not $found)
        shell: pwsh
