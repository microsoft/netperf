name: Custom Tasks

on:
  workflow_dispatch:

permissions: write-all

jobs:
  create-runner:
    name: Create Runner
    runs-on: windows-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Install Latest Az PowerShell Module
      shell: pwsh
      run: |
        Install-Module -Name Az -Force -AllowClobber -Repository PSGallery
        Update-Module Az -Force
        Get-Module 'Az' | where {([string]($_.Version)).StartsWith('9.3.0')} | Remove-Module
        Get-Module -Name Az -ListAvailable
    - name: Login to Azure
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        enable-AzPSSession: true
    - name: Create Azure VMs
      shell: pwsh
      run: |
        ./.github/workflows/create-azure-machines.ps1 `
          -Os windows-2022 `
          -VMSize Experimental_Boost4 `
          -VMSuffix1 c1 `
          -VMSuffix2 c2 `
          -EnvTag azure-custom `
          -GitHubToken ${{ secrets.GITHUB_TOKEN }} `
          -Password ${{ secrets.VM_PASSWORD }}

  test-runner:
    name: Test Runner
    needs: [create-runner]
    timeout-minutes: 5
    runs-on:
    - self-hosted
    - os-windows-2022
    - azure-custom
    steps:
    - name: Test Runner
      shell: pwsh
      run: |
        Write-Host 'Connecting to netperf-peer'
        $Session = New-PSSession -ComputerName "netperf-peer" -ConfigurationName PowerShell.7
        Write-Host "Local IP Config:"
        ipconfig /all
        Write-Host "Peer IP Config:"
        Invoke-Command -Session $Session -ScriptBlock {
          ipconfig /all
        }
        Write-Host "Done!"

  delete-runner:
    name: Delete Runner
    needs: [test-runner]
    runs-on: windows-latest
    if: ${{ always() }}
    steps:
    - name: Login to Azure
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        enable-AzPSSession: true
    - name: Delete Azure VMs
      shell: pwsh
      run: |
        Write-Host "Deleting ex-windows-c1"
        try {
          Remove-AzVm -ResourceGroupName "netperf-ex" -Name "ex-windows-c1" -ForceDeletion $true
        } catch {}
        Write-Host "Deleting ex-windows-c2"
        try {
          Remove-AzVm -ResourceGroupName "netperf-ex" -Name "ex-windows-c1" -ForceDeletion $true
        } catch {}
