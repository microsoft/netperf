name: Exercise RDMA Datapath

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch or Commit'
        required: true
        type: string

permissions: write-all

jobs:
  build-windows:
    name: Build WinUser
    needs: []
    strategy:
      fail-fast: false
      matrix:
        os: ['windows-2022']
        tls: [schannel] # , quictls]
    uses: microsoft/msquic/.github/workflows/build-reuse-win.yml@main
    with:
      config: Debug
      os: ${{ matrix.os }}
      tls: ${{ matrix.tls }}
      build: -Test
      ref: ${{ inputs.ref }}
      arch: x64

  run-msquic-rdma-datapath-test:
    name: Run MsQuic RDMA Datapath Test
    needs: [build-windows]
    runs-on:
      - self-hosted
      - 1ES.Pool=netperf-boosted-windows-pool
      - 1ES.ImageOverride=nvme-enabled-ge_current_directiof_stack-try2
    steps:
      - name: Checkout microsoft/msquic
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
        with:
          repository: microsoft/msquic
          ref: ${{ inputs.ref }}
      - name: Download Artifacts
        uses: actions/download-artifact@8caf195ad4b1dee92908e23f56eeb0696f1dd42d
        with:
          name: Debug-windows-windows-2022-x64-schannel-Test
          path: artifacts
      - name: Install MANA drivers
        run: |
          $ProgressPreference = 'SilentlyContinue'
          # Install MANA drivers.
          Write-Host "Installing MANA drivers."
          try {
              $Tmp = New-TemporaryFile
              $Tmp = Rename-Item -Path $Tmp -NewName "$Tmp.zip" -PassThru
              $TmpDir = New-Item -Path "$Tmp.Dir" -ItemType "Directory"
              Invoke-WebRequest -Uri "https://aka.ms/manawindowsdrivers" -OutFile $Tmp
              Expand-Archive -Path $Tmp -Destination $TmpDir -Force
              pnputil.exe /add-driver "$TmpDir\mana_vf_drivers\mana\manavf.inf" /install
              pnputil.exe /add-driver "$TmpDir\mana_vf_drivers\mana_bus\mana_bus_vf.inf" /install
          } finally {
              Remove-Item $TmpDir -Recurse -ErrorAction SilentlyContinue
              Remove-Item $Tmp -ErrorAction SilentlyContinue
          }
        shell: pwsh
      - name: Prepare machine for RDMA
        run: .\scripts\prepare-machine.ps1 -ForTest -InstallNetworkDirect
        shell: pwsh
      - name: Invoke executable directly to list test cases
        run: Invoke-Expression 'C:\a\_work\netperf\netperf\artifacts\bin\windows\x64_Debug_schannel\msquicplatformtest.exe --gtest_list_tests'
      - name: List test cases
        run: .\scripts\test.ps1 -ListTestCases
      - name: Run Datapath Test
        run: .\scripts\test.ps1 -Config Debug -Arch x64 -Tls schannel
        shell: pwsh
