name: Observe Lab

on:
  workflow_call:
    inputs:
      lab-matrix:
        description: "Lab jobs to observe"
        required: true
        type: string
      project-callee:
        description: "The callee to dispatch workflows to"
        required: true
        type: string
jobs:
  lab-observer:
    name: Oracle
    runs-on: windows-latest
    steps:
    - name: Observing Lab State...
      run: |
        ############################################################################################################
        # INITIALIZATION LOGIC

        # State transition table:
        # 0_AWAIT_MASTER_SLAVE_RESET
        # 1_AWAIT_CALLEE_INITIALIZATION
        # 2_AWAIT_CALLEE_COMPLETION
        # 3_COMPLETED

        ############################################################################################################

        $lab_matrix = ConvertFrom-Json ${{ inputs.lab-matrix }}
        $truth_table = @()
        $num_iterations = 0
        $headers = @{
            "Accept" = "application/vnd.github+json"
            "Authorization" = "Bearer ${{ secrets.GITHUB_TOKEN }}"
            "X-GitHub-Api-Version" = "2022-11-28"
        }

        # Initializing truth table
        while ($truth_table.Count -lt $lab_matrix.Count) {
          $jobs = Get-Jobs -runId ${{ github.run_id }}
          foreach ($job in $jobs) {
            foreach ($todo in $lab_matrix) {
              if ($job.name.Contains($todo.env_str)) {
                if ($job.status -eq "completed") {
                  $truth_table += [PSCustomObject]@{
                    "job" = $job
                    "current_state" = "3_COMPLETED"
                    "conclusion" = $job.conclusion
                    "dispatched_workflow_url" = Get-DispatchedWorkflowUrl -job $job
                  }
                } else {
                  $truth_table += [PSCustomObject]@{
                    "job" = $job
                    "current_state" = "0_AWAIT_MASTER_SLAVE_RESET"
                    "conclusion" = ""
                    "dispatched_workflow_url" = ""
                  }
                }
              }
            }
          }
        }

        ############################################################################################################
        # MAIN OBSERVER LOOP
        ############################################################################################################

        while (NotDoneYet) {
          $num_iterations++
          try {
            foreach ($row in $truth_table) {
              switch ($row.current_state) {
                "0_AWAIT_MASTER_SLAVE_RESET" {
                  $assigned_runner = Get-Assigned-Runner -job $row.job
                  if ($assigned_runner) {
                    DispatchCallee -job $row.job -assigned_runner $assigned_runner
                    $row.current_state = "1_AWAIT_CALLEE_INITIALIZATION"
                  }
                }
                "1_AWAIT_CALLEE_INITIALIZATION" {
                  $callee_workflow_url = Get-DispatchedTestRunWorkflowUrl -job $row.job
                  if ($callee_workflow_url) {
                    $row.dispatched_workflow_url = $callee_workflow_url
                    $row.current_state = "2_AWAIT_CALLEE_COMPLETION"
                  }
                }
                "2_AWAIT_CALLEE_COMPLETION" {
                  $callee_status = Get-Run -runId $row.dispatched_workflow_url
                  if ($callee_status.status -eq "completed") {
                    $row.current_state = "3_COMPLETED"
                    $row.conclusion = $callee_status.conclusion
                  }
                }
                "3_COMPLETED" {
                  # Do nothing
                }
              }
            }
            # Update truth table in shared cache
            $key = "${{ github.run_id }}_${{ github.run_attempt }}_truth_table"
            $value = $truth_table | ConvertTo-Json
            $api = "https://netperfapi.azurewebsites.net/setkeyvalue?key=$key&value=$value"
            Invoke-WebRequest -Uri $api -Headers $headers -Method Post
            DisplayTruthTable
            Start-Sleep -Seconds 20
          } catch {
            Write-Host "Observer loop error: $_"
          }
        }

        ############################################################################################################
        # FUNCTION DEFINITIONS
        ############################################################################################################

        function NotDoneYet {
          $fail_observer = $false
          foreach ($row in $truth_table) {
            if ($row.current_state -ne "3_COMPLETED") {
              return $true
            }
            if ($row.conclusion -neq "success") {
              $fail_observer = $true
            }
          }

          if ($fail_observer) {
            Write-Host "Some jobs failed. Exiting observer loop."
            exit 1
          }

          return $false
        }

        function DispatchCallee {
          param (
            [PSCustomObject]$job,
            [string]$assigned_runner
          )
          $url = "https://api.github.com/repos/microsoft/netperf/dispatches"
          $unique_env_str = "${{ github.run_id }}_${{ github.run_attempt }}_" + $job.env_str
          $body = @{
            event_type = "${{ inputs.project_callee }}"
            client_payload = @{
              assigned_runner = "$assigned_runner",
              unique_env_str = "$unique_env_str",
              os = $job.os,
              io = $job.io,
              tls = $job.tls,
              arch = $job.arch
            } | ConvertTo-Json
          }
        }

        function Get-DispatchedTestRunWorkflowUrl {
          param([PSCustomObject]$job)
          $key = "${{ github.run_id }}_${{ github.run_attempt }}_" + $job.env_str + "_vm_online"
          $url = "https://netperfapi.azurewebsites.net/getkeyvalue?key=$key"
          try {
            $response = Invoke-WebRequest -Uri $url -Headers $headers -Method Get
            return $response.Content
          } catch {
            Write-Host "Failed to get dispatched test run workflow URL: $_"
            return $null
          }
        }

        function DisplayTruthTable {
          // TODO
        }

        function Get-Assigned-Runner {
          param([PSCustomObject]$job)

          $master_key = "${{ github.run_id }}_${{ github.run_attempt }}_" + $job.env_str + "_master_reset_done"
          $slave_key = "${{ github.run_id }}_${{ github.run_attempt }}_" + $job.env_str + "_slave_reset_done"
          $master_url = "https://netperfapi.azurewebsites.net/getkeyvalue?key=$master_key"
          $slave_url = "https://netperfapi.azurewebsites.net/getkeyvalue?key=$slave_key"
          try {
            $master_response = Invoke-WebRequest -Uri $master_url -Headers $headers -Method Get
            $slave_response = Invoke-WebRequest -Uri $slave_url -Headers $headers -Method Get

            // TODO

          } catch {
            Write-Host "Failed to get assigned runner: $_"
          }
        }

        function Get-Jobs {
            param([string]$runId)
            $url = "https://api.github.com/repos/microsoft/netperf/actions/runs/$runId/jobs"
            Write-Debug "GET $url"
            return ((Invoke-WebRequest -Uri $url -Method GET -Headers $headers).Content | ConvertFrom-Json).jobs
        }

      shell: pwsh
