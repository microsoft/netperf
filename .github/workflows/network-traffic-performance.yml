name: network-traffic-performance

# Generic network traffic performance workflow (replaces UDP-specific variant)
on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Test Branch or Commit'
        required: false
        default: 'main'
        type: string
      profile:
        description: 'Capture CPU profile'
        required: false
        default: false
        type: boolean
      tcp_ip_tracing:
        description: 'Capture TCP/IP tracing (WPR)'
        required: false
        default: false
        type: boolean
      sender_options:
        description: 'Command-line options for the sender (quoted string)'
        required: true
        type: string
      receiver_options:
        description: 'Command-line options for the receiver (quoted string)'
        required: true
        type: string

concurrency:
  group: >-
    traffic-${{ github.event.client_payload.sha || inputs.ref || github.event.pull_request.number || 'main' }}
  cancel-in-progress: true

jobs:
  build_cts_traffic:
    name: Build cts-traffic
    uses: microsoft/ctsTraffic/.github/workflows/reusable-build.yml@master
    with:
      build_artifact: cts-traffic
      repository: 'microsoft/ctsTraffic'
      configurations: '["Release"]'
      ref: 'master'

  test:
    name: Network Traffic Test
    needs: [build_cts_traffic]
    strategy:
      fail-fast: false
      matrix:
        vec:
          - env: lab
            os: "2022"
            arch: x64
    runs-on:
      - self-hosted
      - ${{ matrix.vec.env }}
      - os-windows-${{ matrix.vec.os }}
      - ${{ matrix.vec.arch }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@9bb56186c3b09b4f86b1c65136769dd318469633

    - name: Setup workspace
      run: |-
        Get-ChildItem  | % { Remove-Item -Recurse $_ -Force -ErrorAction SilentlyContinue }
        if (Test-Path ${{ github.workspace }}\cts-traffic) { Remove-Item -Recurse -Force ${{ github.workspace }}\cts-traffic }
        if (Test-Path ${{ github.workspace }}\ETL) { Remove-Item -Recurse -Force ${{ github.workspace }}\ETL }
        New-Item -ItemType Directory -Path ${{ github.workspace }}\cts-traffic
        New-Item -ItemType Directory -Path ${{ github.workspace }}\ETL

    - name: Download cts-traffic
      uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
      with:
        name: "cts-traffic Release"
        path: ${{ github.workspace }}\cts-traffic

    - name: Optional - Start TCPIP tracing
      if: ${{ github.event.inputs.tcp_ip_tracing == 'true' }}
      run: |-
        if (Test-Path "tcpip.wprp") { Remove-Item -Force "tcpip.wprp" }
        Invoke-WebRequest -uri "https://raw.githubusercontent.com/microsoft/netperf/${{inputs.ref}}/.github/workflows/tcpip.wprp" -OutFile "tcpip.wprp"
        wpr -start tcpip.wprp -filemode

    - name: Download run-traffic-test script
      working-directory: ${{ github.workspace }}\cts-traffic
      run: |
        Invoke-WebRequest -uri "https://raw.githubusercontent.com/microsoft/netperf/${{inputs.ref}}/.github/scripts/run-traffic-test.ps1" -OutFile ".\run-traffic-test.ps1"

    - name: Log all input parameters for this workflow
      run: |
        Write-Output "Input parameters:"
        Write-Output "  Profile: ${{ inputs.profile }}"
        Write-Output "  SenderOptions: ${{ inputs.sender_options }}"
        Write-Output "  ReceiverOptions: ${{ inputs.receiver_options }}"
        Write-Output "  TCP IP Tracing: ${{ inputs.tcp_ip_tracing }}"
        Write-Output "  ref: ${{ inputs.ref }}"

    - name: Run traffic tests
      working-directory: ${{ github.workspace }}\cts-traffic
      env:
        PROFILE: ${{ inputs.profile }}
        SENDER_OPTIONS: ${{ inputs.sender_options }}
        RECEIVER_OPTIONS: ${{ inputs.receiver_options }}
      shell: pwsh
      run: |
        # Build the command and only include -CpuProfile when PROFILE is truthy ('true' or true)
        $cpuSwitch = ''
        if ($env:PROFILE -eq 'true' -or $env:PROFILE -eq 'True' -or $env:PROFILE -eq 'TRUE' -or $env:PROFILE -eq $true) {
          $cpuSwitch = '-CpuProfile'
        }

        $cmd = @(
          '.\\run-traffic-test.ps1',
          $cpuSwitch,
          '-PeerName', '"netperf-peer"',
          '-SenderOptions', '"' + $env:SENDER_OPTIONS + '"',
          '-ReceiverOptions', '"' + $env:RECEIVER_OPTIONS + '"'
        ) -join ' '

        Write-Output "Running: $cmd"
        Invoke-Expression $cmd

    - name: Optional - Stop TCPIP tracing
      if: ${{ github.event.inputs.tcp_ip_tracing == 'true' }}
      run: |
        wpr -stop ${{ github.workspace }}\ETL\tcpip_trace.etl

    - name: Upload CTS results
      if: always()
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
      with:
        name: cts_traffic_${{ matrix.vec.env }}_${{ matrix.vec.os }}_${{ matrix.vec.arch }}
        path: |
          ${{ github.workspace }}\cts-traffic\*.csv
          ${{ github.workspace }}\cts-traffic\*.log

    - name: Upload TCPIP ETL
      if: always()
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
      with:
        name: tcpip_trace_${{ matrix.vec.env }}_${{ matrix.vec.os }}_${{ matrix.vec.arch }}
        path: ${{ github.workspace }}\ETL\tcpip_trace.etl

    - name: Upload CPU Profile
      if:  always()
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
      with:
        name: cpu_profile_${{ matrix.vec.env }}_${{ matrix.vec.os }}_${{ matrix.vec.arch }}
        path: ${{ github.workspace }}\ETL\cpu_profile-*.etl